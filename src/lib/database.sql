-- Create updated_at trigger function
CREATE OR REPLACE FUNCTION handle_updated_at()
RETURNS TRIGGER AS $$
BEGIN
  NEW.updated_at = CURRENT_TIMESTAMP;
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- Create activity log trigger function
CREATE OR REPLACE FUNCTION log_activity()
RETURNS TRIGGER AS $$
BEGIN
  INSERT INTO activity_log (
    event_type,
    order_id,
    from_token,
    to_token,
    from_amount,
    to_amount,
    wallet_address
  ) VALUES (
    TG_OP,
    NEW.id,
    NEW.from_token,
    NEW.to_token,
    NEW.from_amount,
    NEW.to_amount,
    NEW.wallet_address
  );
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- Create token_price_history table
CREATE TABLE IF NOT EXISTS public.token_price_history (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  symbol TEXT NOT NULL,
  price_usd NUMERIC NOT NULL,
  timestamp TIMESTAMPTZ DEFAULT now()
);

-- Create index for faster queries
CREATE INDEX IF NOT EXISTS idx_token_price_history_symbol_timestamp 
  ON token_price_history (symbol, timestamp);

-- Create function to log price history
CREATE OR REPLACE FUNCTION log_price_history()
RETURNS TRIGGER AS $$
BEGIN
  INSERT INTO token_price_history (symbol, price_usd)
  VALUES (NEW.symbol, NEW.price_usd);
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- Create tables function
CREATE OR REPLACE FUNCTION create_tables()
RETURNS void
LANGUAGE plpgsql
SECURITY DEFINER
AS $$
BEGIN
  -- Create activity_log table
  CREATE TABLE IF NOT EXISTS public.activity_log (
    id bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    event_type text NOT NULL,
    order_id bigint NOT NULL,
    from_token text NOT NULL,
    to_token text NOT NULL,
    from_amount numeric NOT NULL,
    to_amount numeric NOT NULL,
    wallet_address text,
    created_at timestamptz DEFAULT now()
  );

  -- Create orders table
  CREATE TABLE IF NOT EXISTS public.orders (
    id bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    from_token text NOT NULL,
    to_token text NOT NULL,
    from_amount numeric NOT NULL,
    to_amount numeric NOT NULL,
    swap_tx text NOT NULL,
    claimed boolean DEFAULT false,
    claim_count integer DEFAULT 0,
    status text DEFAULT 'active',
    wallet_address text,
    created_at timestamptz DEFAULT now(),
    updated_at timestamptz DEFAULT now()
  );

  -- Create tokens table
  CREATE TABLE IF NOT EXISTS public.tokens (
    symbol text PRIMARY KEY,
    price_usd numeric NOT NULL DEFAULT 0,
    market_cap numeric NOT NULL DEFAULT 0,
    last_updated timestamptz DEFAULT now()
  );

  -- Add triggers
  DROP TRIGGER IF EXISTS handle_updated_at_orders ON public.orders;
  CREATE TRIGGER handle_updated_at_orders
    BEFORE UPDATE ON public.orders
    FOR EACH ROW
    EXECUTE FUNCTION handle_updated_at();

  DROP TRIGGER IF EXISTS log_activity_insert ON public.orders;
  CREATE TRIGGER log_activity_insert
    AFTER INSERT ON public.orders
    FOR EACH ROW
    EXECUTE FUNCTION log_activity();

  DROP TRIGGER IF EXISTS log_activity_update ON public.orders;
  CREATE TRIGGER log_activity_update
    AFTER UPDATE ON public.orders
    FOR EACH ROW
    WHEN (OLD.claimed IS DISTINCT FROM NEW.claimed)
    EXECUTE FUNCTION log_activity();

  DROP TRIGGER IF EXISTS log_price_history_trigger ON public.tokens;
  CREATE TRIGGER log_price_history_trigger
    AFTER UPDATE OF price_usd ON public.tokens
    FOR EACH ROW
    EXECUTE FUNCTION log_price_history();

  -- Enable RLS
  ALTER TABLE public.activity_log ENABLE ROW LEVEL SECURITY;
  ALTER TABLE public.orders ENABLE ROW LEVEL SECURITY;
  ALTER TABLE public.tokens ENABLE ROW LEVEL SECURITY;
  ALTER TABLE public.token_price_history ENABLE ROW LEVEL SECURITY;

  -- Create policies
  DROP POLICY IF EXISTS "Enable read access for all users" ON public.activity_log;
  CREATE POLICY "Enable read access for all users" ON public.activity_log
    FOR SELECT TO anon USING (true);

  DROP POLICY IF EXISTS "Enable read access for all users" ON public.orders;
  CREATE POLICY "Enable read access for all users" ON public.orders
    FOR SELECT TO anon USING (true);

  DROP POLICY IF EXISTS "Enable insert for all users" ON public.orders;
  CREATE POLICY "Enable insert for all users" ON public.orders
    FOR INSERT TO anon WITH CHECK (true);

  DROP POLICY IF EXISTS "Enable update for all users" ON public.orders;
  CREATE POLICY "Enable update for all users" ON public.orders
    FOR UPDATE TO anon USING (true);

  DROP POLICY IF EXISTS "Enable read access for all users" ON public.tokens;
  CREATE POLICY "Enable read access for all users" ON public.tokens
    FOR SELECT TO anon USING (true);

  DROP POLICY IF EXISTS "Enable update for all users" ON public.tokens;
  CREATE POLICY "Enable update for all users" ON public.tokens
    FOR UPDATE TO anon USING (true);

  DROP POLICY IF EXISTS "Enable read access for all users" ON public.token_price_history;
  CREATE POLICY "Enable read access for all users" ON public.token_price_history
    FOR SELECT TO anon USING (true);
END;
$$;